const J=window;function Y(o,E,V={}){const l=Object.assign({tab:"	",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:J},V),O=l.window,b=O.document;let A=[],h=[],f=-1,L=!1,N,D;o.setAttribute("contenteditable","plaintext-only"),o.setAttribute("spellcheck",l.spellcheck?"true":"false"),o.style.outline="none",o.style.overflowWrap="break-word",o.style.overflowY="auto",o.style.whiteSpace="pre-wrap";let k=!1;E(o),o.contentEditable!=="plaintext-only"&&(k=!0),k&&o.setAttribute("contenteditable","true");const W=U(()=>{const e=u();E(o,e),d(e)},30);let x=!1;const R=e=>!P(e)&&!B(e)&&e.key!=="Meta"&&e.key!=="Control"&&e.key!=="Alt"&&!e.key.startsWith("Arrow"),q=U(e=>{R(e)&&(w(),x=!1)},300),T=(e,t)=>{A.push([e,t]),o.addEventListener(e,t)};T("keydown",e=>{e.defaultPrevented||(D=C(),l.preserveIdent?F(e):_(e),l.catchTab&&X(e),l.addClosing&&I(e),l.history&&(Z(e),R(e)&&!x&&(w(),x=!0)),k&&d(u()))}),T("keyup",e=>{e.defaultPrevented||e.isComposing||(D!==C()&&W(),q(e),N&&N(C()))}),T("focus",e=>{L=!0}),T("blur",e=>{L=!1}),T("paste",e=>{w(),z(e),w(),N&&N(C())});function u(){const e=m(),t={start:0,end:0,dir:void 0};let{anchorNode:n,anchorOffset:s,focusNode:r,focusOffset:c}=e;if(!n||!r)throw"error1";if(n.nodeType===Node.ELEMENT_NODE){const i=b.createTextNode("");n.insertBefore(i,n.childNodes[s]),n=i,s=0}if(r.nodeType===Node.ELEMENT_NODE){const i=b.createTextNode("");r.insertBefore(i,r.childNodes[c]),r=i,c=0}return H(o,i=>{if(i===n&&i===r)return t.start+=s,t.end+=c,t.dir=s<=c?"->":"<-","stop";if(i===n)if(t.start+=s,!t.dir)t.dir="->";else return"stop";else if(i===r)if(t.end+=c,!t.dir)t.dir="<-";else return"stop";i.nodeType===Node.TEXT_NODE&&(t.dir!="->"&&(t.start+=i.nodeValue.length),t.dir!="<-"&&(t.end+=i.nodeValue.length))}),o.normalize(),t}function d(e){const t=m();let n,s=0,r,c=0;if(e.dir||(e.dir="->"),e.start<0&&(e.start=0),e.end<0&&(e.end=0),e.dir=="<-"){const{start:a,end:y}=e;e.start=y,e.end=a}let i=0;H(o,a=>{if(a.nodeType!==Node.TEXT_NODE)return;const y=(a.nodeValue||"").length;if(i+y>e.start&&(n||(n=a,s=e.start-i),i+y>e.end))return r=a,c=e.end-i,"stop";i+=y}),n||(n=o,s=o.childNodes.length),r||(r=o,c=o.childNodes.length),e.dir=="<-"&&([n,s,r,c]=[r,c,n,s]),t.setBaseAndExtent(n,s,r,c)}function M(){const t=m().getRangeAt(0),n=b.createRange();return n.selectNodeContents(o),n.setEnd(t.startContainer,t.startOffset),n.toString()}function S(){const t=m().getRangeAt(0),n=b.createRange();return n.selectNodeContents(o),n.setStart(t.endContainer,t.endOffset),n.toString()}function F(e){if(e.key==="Enter"){const t=M(),n=S();let[s]=j(t),r=s;if(l.indentOn.test(t)&&(r+=l.tab),r.length>0?(p(e),e.stopPropagation(),g(`
`+r)):_(e),r!==s&&l.moveToNewLine.test(n)){const c=u();g(`
`+s),d(c)}}}function _(e){if(k&&e.key==="Enter")if(p(e),e.stopPropagation(),S()==""){g(`
 `);const t=u();t.start=--t.end,d(t)}else g(`
`)}function I(e){const t=`([{'"`,n=`)]}'"`,s=S(),r=M(),c=r.substr(r.length-1)==="\\",i=s.substr(0,1);if(n.includes(e.key)&&!c&&i===e.key){const a=u();p(e),a.start=++a.end,d(a)}else if(t.includes(e.key)&&!c&&(`"'`.includes(e.key)||[""," ",`
`].includes(i))){p(e);const a=u(),y=a.start==a.end?"":m().toString(),G=e.key+y+n[t.indexOf(e.key)];g(G),a.start++,a.end++,d(a)}}function X(e){if(e.key==="Tab")if(p(e),e.shiftKey){const t=M();let[n,s]=j(t);if(n.length>0){const r=u(),c=Math.min(l.tab.length,n.length);d({start:s,end:s+c}),b.execCommand("delete"),r.start-=c,r.end-=c,d(r)}}else g(l.tab)}function Z(e){if(P(e)){p(e),f--;const t=h[f];t&&(o.innerHTML=t.html,d(t.pos)),f<0&&(f=0)}if(B(e)){p(e),f++;const t=h[f];t&&(o.innerHTML=t.html,d(t.pos)),f>=h.length&&f--}}function w(){if(!L)return;const e=o.innerHTML,t=u(),n=h[f];if(n&&n.html===e&&n.pos.start===t.start&&n.pos.end===t.end)return;f++,h[f]={html:e,pos:t},h.splice(f+1);const s=300;f>s&&(f=s,h.splice(0,1))}function z(e){p(e);const t=(e.originalEvent||e).clipboardData.getData("text/plain").replace(/\r/g,""),n=u();g(t),E(o),d({start:Math.min(n.start,n.end)+t.length,end:Math.min(n.start,n.end)+t.length,dir:"<-"})}function H(e,t){const n=[];e.firstChild&&n.push(e.firstChild);let s=n.pop();for(;s&&t(s)!=="stop";)s.nextSibling&&n.push(s.nextSibling),s.firstChild&&n.push(s.firstChild),s=n.pop()}function K(e){return e.metaKey||e.ctrlKey}function P(e){return K(e)&&!e.shiftKey&&e.code==="KeyZ"}function B(e){return K(e)&&e.shiftKey&&e.code==="KeyZ"}function g(e){e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),b.execCommand("insertHTML",!1,e)}function U(e,t){let n=0;return(...s)=>{clearTimeout(n),n=O.setTimeout(()=>e(...s),t)}}function j(e){let t=e.length-1;for(;t>=0&&e[t]!==`
`;)t--;t++;let n=t;for(;n<e.length&&/[ \t]/.test(e[n]);)n++;return[e.substring(t,n)||"",t,n]}function C(){return o.textContent||""}function p(e){e.preventDefault()}function m(){var e;return((e=o.parentNode)===null||e===void 0?void 0:e.nodeType)==Node.DOCUMENT_FRAGMENT_NODE?o.parentNode.getSelection():O.getSelection()}return{updateOptions(e){Object.assign(l,e)},updateCode(e){o.textContent=e,E(o)},onUpdate(e){N=e},toString:C,save:u,restore:d,recordHistory:w,destroy(){for(let[e,t]of A)o.removeEventListener(e,t)}}}export{Y as CodeJar};
